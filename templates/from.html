<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Form 1</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>



        body {
            background: url('/static/bg.jpg') no-repeat center center fixed;
            background-size: cover;
            margin-bottom: 20px;
        }
        
        .teaching-process-container {
            margin-top: 150px;
        }

        .top-bar {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .top-bar a {
            margin-left: 15px;
            color: white;
            text-decoration: none;
            font-weight: bold;
        }

        .top-bar a:hover {
            text-decoration: underline;
        }

        .logo-link {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .logo-link img {
            width: 90px;
            height: auto;
        }

       /* Update the container to be wider */
       .table-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-bottom: 50px;
            padding: 20px;
            width: 100%; /* Ensure full width */
        }
    
        .table-box {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1200px; /* Increase max-width for wider content */
            text-align: center;
            margin-bottom: 40px;
            transition: transform 0.3s ease-in-out;
        }

        .table-box:hover {
            transform: scale(1.02);
        }

        .table-title {
            margin-bottom: 20px;
            font-size: 24px;
            color: #00796b;
            transition: color 0.3s;
        }

        .table-title:hover {
            color: #004d40;
        }

        .total-box {
    margin-top: 20px;
    font-weight: bold;
    font-size: 18px;
    color: rgb(248, 254, 254);
    background-color: rgba(72, 69, 69, 0.7); /* Dark semi-transparent background */
    padding: 10px; /* Add some padding for better spacing */
    border-radius: 8px; /* Rounded corners for a nicer look */
    transition: color 0.3s, background-color 0.3s; /* Smooth transition for color changes */
}

        /* View button styling */
        .btn-view {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
        }
        
        .btn-view:hover {
            background-color: #138496;
            border-color: #117a8b;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .d-flex {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-upload-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }


        .total-box span {
            font-size: 24px;
            color: #ff9728;
        }

        .total-box span.flash {
            animation: flash 1s ease-in-out infinite;
        }

        @keyframes flash {
            0%, 100% {
                color: #e6930d;
            }

            50% {
                color: #eb8f1f;
            }
        }

        .action-buttons {
            margin-top: 20px;
        }

        .table th,
        .table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table td:first-child {
            width: 20%;
        }

        .table td:nth-child(2) {
            width: 40%;
        }

        .table td:nth-child(3),
        .table td:nth-child(4) {
            width: 20%;
        }

        .table td:last-child {
            width: 10%;
        }

        .table input.form-control {
            width: 100%;
            box-sizing: border-box;
        }

        .table input:focus {
            border-color: #00796b;
            box-shadow: 0 0 5px rgba(0, 121, 107, 0.5);
        }

        .btn-success,
        .btn-primary,
        .btn-secondary {
            transition: background-color 0.3s ease;
            
        }

        .btn-success:hover {
            background-color: #00695c;
        }

        .btn-primary:hover {
            background-color: #004d40;
        }

        .btn-secondary:hover {
            background-color: #004d40;
        }

        /* Spacing between forms */
        .form-section {
            margin-bottom: 50px;
        }

        .undo-button {
            display: inline-block;
            margin-left: 20px;
        }
        .instructions {
            font-weight: bold;
    text-align: left;
   
    margin-left: 20px; /* Adjust the value as needed for spacing */
    font-size: 14px; /* You can modify the font size as needed */
    line-height: 1.6; /* Improves readability with proper line spacing */
    padding: 10px; /* Adds some padding around the text */
}

input[required] {
    border: 1px solid #ccc;  /* Default border */
}

input[required]:invalid {
    border-color: red;  /* Red border for invalid inputs */
}

#flashMessage {
    padding: 10px;
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 5px;
}

.heading {
    text-align: center;
    font-size: 24px;
}
.footer {
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 20px 0;
        }

        .footer a {
            color: #ff9800;
            text-decoration: none;
            font-weight: bold;
        }

        .footer a:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>
    <div class="top-bar">
        
        <a href="/logout">Logout</a>
    </div>

    <!-- Logo -->
    <a href="/landing" class="logo-link">
        <img src="/static/logo.png" alt="Logo">
    </a>
    <div id="flashMessage" style="display:none; color: red; font-weight: bold; margin-bottom: 10px;"></div>
    
    <h1 class="heading">Form for {{ department }} Department</h1>


   
        <input type="hidden" name="user_id" value="{{ user_id }}">
        <input type="hidden" name="form_id" value="{{ form_id }}">

    <!-- Teaching Process Form -->
<div class="table-container teaching-process-container">
    <div class="table-box">
        <h3 class="table-title">Teaching Process</h3>
        <div class="instructions">
            <p>
                1. Enter the Semester (in roman) and the Subject name, <br>
                the classes scheduled and held must be entered accurately.<br>
                2. The marks for his/her performance will be calculated accordingly.<br>
                <h5>Statistics of Lecture/Practical Conducted (Max Marks:5)</h5>
            </p>
        </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Sr. No.</th>
                    <th>Semester</th>
                    <th>Course Code/Name</th>
                    <th>Classes Scheduled(S)</th>
                    <th>Classes Held(H)</th>
                    <th>Points (H/S)*5</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="classTable">
                {% for row in teaching_data %}
                <tr data-srno="{{ loop.index }}" data-id="{{ row.id if row.id else '' }}">
                    <td class="sr-no">{{ loop.index }}</td>
                    <td>
                        <select class="form-control semester" required>
                            <option value="">Select</option>
                            <option value="I" {% if row[0] == 'I' %}selected{% endif %}>I</option>
                            <option value="II" {% if row[0] == 'II' %}selected{% endif %}>II</option>
                            <option value="III" {% if row[0] == 'III' %}selected{% endif %}>III</option>
                            <option value="IV" {% if row[0] == 'IV' %}selected{% endif %}>IV</option>
                            <option value="V" {% if row[0] == 'V' %}selected{% endif %}>V</option>
                            <option value="VI" {% if row[0] == 'VI' %}selected{% endif %}>VI</option>
                            <option value="VII" {% if row[0] == 'VII' %}selected{% endif %}>VII</option>
                            <option value="VIII" {% if row[0] == 'VIII' %}selected{% endif %}>VIII</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-control course-dropdown" required title="Select Course">
                            <option value="">Select Course</option>
                            {% if row[1] %}
                                <option value="{{ row[1] }}" selected>{{ row[1] }}</option>
                            {% endif %}
                        </select>
                    </td>
                    <td><input type="number" class="form-control classes-scheduled" value="{{ row[2] }}" oninput="calculatePoints(this)" required></td>
                    <td><input type="number" class="form-control classes-held" value="{{ row[3] }}" oninput="calculatePoints(this)" required></td>
                    <td><input type="number" class="form-control points" value="{{ row[4] | round(2, 'common') }}" step="0.01" min="0" readonly></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRow(this, 'teaching')">-</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <button class="btn btn-success" onclick="addRow()">+</button>
    </div>

    <div class="table-container">
        <div class="table-box">
            <h3 class="table-title">Numeric Points Attained on basis of Academic Review (Max Marks: 20)</h3>
            <div class="instructions">
                <p>
                    1. Enter the points obtained through academic review (max 20 points)<br>
                    2. The total will be calculated automatically
                </p>
                <div id="academicReviewError" class="error-message" style="display: none; color: red; margin-top: 5px;"></div>
            </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Sr. No.</th>
                    <th>Academic Review 1</th>
                    <th>Academic Review 2</th>
                    <th>Average Score</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="academicReviewTable">
                {% if academic_review_data and academic_review_data|length > 0 %}
                    {% for row in academic_review_data %}
                    <tr data-srno="{{ row[0] }}">
                        <td class="sr-no">{{ row[0] }}</td>
                        <td><input type="number" class="form-control academic-review" value="{{ row[1] }}" min="0" max="20" oninput="calculateAcademicReview()" required></td>
                        <td><input type="number" class="form-control academic-review" value="{{ row[2] }}" min="0" max="20" oninput="calculateAcademicReview()" required></td>
                        <td><input type="number" class="form-control academic-review-avg" value="{{ row[3] }}" readonly></td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteRow(this, 'academic_review')">-</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr data-srno="1">
                        <td class="sr-no">1</td>
                        <td><input type="number" class="form-control academic-review" value="" min="0" max="20" oninput="calculateAcademicReview()" required></td>
                        <td><input type="number" class="form-control academic-review" value="" min="0" max="20" oninput="calculateAcademicReview()" required></td>
                        <td><input type="number" class="form-control academic-review-avg" value="" readonly></td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteRow(this, 'academic_review')">-</button>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
        <button class="btn btn-success" onclick="addAcademicReviewRow()">+</button>
        </div>
    </div>

    <div class="total-box">
        Total Points: <span id="totalPoints">0</span> /25
    </div>
</div>

<!-- Students Feedback Form -->
<div class="table-container form-section">
    <div class="table-box">
        <h3 class="table-title">Students Feedback</h3>
        <div class="instructions">
            <p>
                1. Enter the points obtained through student feedback for each subject (max 5 per subject)<br>
            </p>
        </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Sr. No.</th>
                    <th>Semester</th>
                    <th>Course Code/Name</th>
                    <th>Total Points</th>
                    <th>Points Obtained</th>
                    <th>Upload Document</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="feedbackTable">
                {% for row in feedback_data %}
                <tr data-srno="{{ loop.index }}" data-id="{{ row.id if row.id else '' }}">
                    <td class="sr-no">{{ loop.index }}</td>
                    <td>
                        <select class="form-control semester" required>
                            <option value="">Select</option>
                            <option value="I" {% if row[0] == 'I' %}selected{% endif %}>I</option>
                            <option value="II" {% if row[0] == 'II' %}selected{% endif %}>II</option>
                            <option value="III" {% if row[0] == 'III' %}selected{% endif %}>III</option>
                            <option value="IV" {% if row[0] == 'IV' %}selected{% endif %}>IV</option>
                            <option value="V" {% if row[0] == 'V' %}selected{% endif %}>V</option>
                            <option value="VI" {% if row[0] == 'VI' %}selected{% endif %}>VI</option>
                            <option value="VII" {% if row[0] == 'VII' %}selected{% endif %}>VII</option>
                            <option value="VIII" {% if row[0] == 'VIII' %}selected{% endif %}>VIII</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-control course-dropdown" required title="Select Course">
                            <option value="">Select Course</option>
                            {% if row[1] %}
                                <option value="{{ row[1] }}" selected>{{ row[1] }}</option>
                            {% endif %}
                        </select>
                    </td>
                    <td><input type="number" class="form-control total-points" value="{{ row[2] }}" readonly></td>
                    <td><input type="number" class="form-control points-obtained" 
                        value="{{ row[3] }}" 
                        min="0" 
                        max="5" 
                        step="0.1"
                        oninput="calculateFeedbackTotal()" 
                        onblur="this.value = Math.min(5, Math.max(0, parseFloat(this.value) || 0)).toFixed(1)"
                        required>
                    </td>
                    <td>
                        <div class="file-upload-section">
                            <input type="file" name="feedback_{{ loop.index }}_file" class="form-control" accept=".pdf,.doc,.docx">
                            {% if row[4] and row[4].strip() %}
                                <button class="btn btn-view" onclick="window.open('/{{ row[4] }}', '_blank')" title="View uploaded document">View</button>
                            {% else %}
                                <button class="btn btn-view" disabled title="No document uploaded yet" style="opacity: 0.5; cursor: not-allowed;">View</button>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRow(this, 'feedback')">-</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button class="btn btn-success" onclick="addFeedbackRow()">+</button>
    </div>
    <div class="total-box">
        Total Points : <span id="totalPointsObtained">0</span> /25
    </div>
</div>

    <!-- Save, Reset, Next Buttons -->
    <div class="container text-center mt-4">
        <div id="errorContainer" style="color: red; font-weight: bold; margin-bottom: 10px;"></div>
        <button class="btn btn-secondary mx-2" onclick="resetFields()">Reset</button>
        <button class="btn btn-primary mx-2" onclick="validateAndSave()">Save</button>
        <button class="btn btn-secondary mx-2" onclick="goToNext()">Next</button>
    </div>

    <input type="hidden" id="formId" value="{{ form_id }}">

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/data/courses.js"></script>

    <script>
        // Store the previous states for Undo functionality
        let previousTeachingState = [];
        let previousFeedbackState = [];

        // Enforce max 5 points for feedback
        function validateMaxPoints(input) {
            if (parseInt(input.value) > 5) {
                input.value = 5;
            } else if (parseInt(input.value) < 0) {
                input.value = 0;
            }
        }

        // Validation Function for individual fields
        function validateField(field) {
            // No need to show messages here since we are using a single error message
            if (!field.value.trim()) {
                field.style.borderColor = 'red';  // Highlight invalid field
                return false;
            } else {
                field.style.borderColor = '';     // Reset field styling if valid
                return true;
            }
        }

        // Validate all fields in the form before saving
        function validateAndSave() {
            let isValid = true;

            // Clear any previous error messages
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = '';

            // Validate Teaching Process form
            document.querySelectorAll('#classTable input[required]').forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                }
            });

            // Validate Feedback form
            document.querySelectorAll('#feedbackTable input[required]').forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                }
            });

            // If all fields are valid, proceed to save form data
            if (isValid) {
                saveFormData();  // This is your form submission logic
            } else {
                // Show error message for invalid form
                errorContainer.textContent = 'Please fill in all required fields.';
            }
        }

        // Attach event listeners for real-time validation
        document.querySelectorAll('#classTable input[required]').forEach(input => {
            input.addEventListener('input', function() {
                validateField(this);  // Validate on input
            });
        });

        document.querySelectorAll('#feedbackTable input[required]').forEach(input => {
            input.addEventListener('input', function() {
                validateField(this);  // Validate on input
            });
        });

 
    // Department passed from Flask - this variable is used throughout the script
    const userDepartment = "{{ department }}";

    // Event listener for semester selection changes
    document.getElementById('classTable').addEventListener('change', function (event) {
    if (event.target.matches('select[title="Select Semester"]')) {
        populateCourses(event.target);
    }
});



function populateCourses(selectElement) {
    const semester = selectElement.value;
    const courseDropdown = selectElement.closest('tr').querySelector('.course-dropdown');

    // Clear previous options
    courseDropdown.innerHTML = '<option value="">Select Course</option>';

    // Check if the department and semester have valid courses
    if (coursesByDepartment[userDepartment] && coursesByDepartment[userDepartment][semester]) {
        coursesByDepartment[userDepartment][semester].forEach(course => {
            const option = document.createElement('option');
            option.value = course;
            option.textContent = course;
            courseDropdown.appendChild(option);
        });
    } else {
        courseDropdown.innerHTML = '<option value="">No courses available</option>';
    }
    console.log("Selected Semester:", semester);
console.log("Available Courses:", coursesByDepartment[userDepartment]?.[semester]);

}




  // Helper function to update serial numbers
function updateSerialNumbers(tableId) {
    const rows = document.querySelectorAll(`#${tableId} .sr-no`);
    rows.forEach((cell, index) => {
        cell.textContent = index + 1;
    });
}

// Add new row to Teaching Process table
function addRow() {
    const table = document.getElementById('classTable');
    const newRow = table.insertRow();

    newRow.innerHTML = `
        <td class="sr-no"></td>
        <td>
                <select class="form-control semester" required title="Select Semester" onchange="populateCourses(this)">
                    <option value="">Select</option>
                    <option value="I">I</option>
                    <option value="II">II</option>
                    <option value="III">III</option>
                    <option value="IV">IV</option>
                    <option value="V">V</option>
                    <option value="VI">VI</option>
                    <option value="VII">VII</option>
                    <option value="VIII">VIII</option>
                </select>
            </td>
            <td>
                <select class="form-control course-dropdown" required title="Select Course">
                    <option value="">Select Course</option>
                </select>
            </td>
            <td><input type="number" class="form-control classes-scheduled" required title="Enter Classes Scheduled" oninput="calculatePoints(this)" onblur="validateField(this)"></td>
            <td><input type="number" class="form-control classes-held" required title="Enter Classes Held" oninput="calculatePoints(this)" onblur="validateField(this)"></td>
            <td><input type="number" class="form-control points" value="0" readonly title="Calculated Points"></td>
            <td><button class="btn btn-danger" onclick="deleteRow(this, 'teaching')">-</button></td>
        `;

    updateSerialNumbers('classTable');
}

// Add new row to Feedback table
function addFeedbackRow() {
    const feedbackTable = document.getElementById('feedbackTable');
    const newRow = feedbackTable.insertRow();

    newRow.innerHTML = `
        <td class="sr-no"></td>
        <td>
            <select class="form-control semester" required title="Select Semester" onchange="populateCourses(this)">
                <option value="">Select</option>
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III">III</option>
                <option value="IV">IV</option>
                <option value="V">V</option>
                <option value="VI">VI</option>
                <option value="VII">VII</option>
                <option value="VIII">VIII</option>
            </select>
        </td>
        <td><select class="form-control course-dropdown" required title="SelectCourse">
            <option value="">Select Course</option>
            <!-- Options will be populated dynamically -->
        </select></td>
        <td><input type="number" class="form-control total-points" value=5 readonly title="Total points available"></td>
        <td><input type="number" class="form-control points-obtained" required oninput="calculateFeedbackTotal()" min="0" max="5" onblur="validateField(this)" title="Enter the points obtained"></td>
        <td>
                            <input type="file" class="form-control-file" onchange="uploadDocument(this)">
                            <div class="upload-status"></div>
                        </td>
        <td><button class="btn btn-danger" onclick="deleteRow(this, 'feedback')">-</button></td>
    `;

    updateSerialNumbers('feedbackTable');
}


let deletedTeachingRows = [];
let deletedFeedbackRows = [];
let deletedAcademicReviewRows = [];

// Function to delete a row from any table
function deleteRow(button, tableType) {
    const row = button.closest('tr');
    const rowId = row.getAttribute('data-id');
    const srno = row.querySelector('.sr-no')?.textContent.trim();
    const formId = document.getElementById('formId')?.value;
    
    if (confirm('Are you sure you want to delete this row?')) {
        // For academic review rows, we need to use a different endpoint
        if (tableType === 'academic_review' && formId && srno) {
            // Store the row ID and srno in our tracking array before deleting
            if (rowId) {
                deletedAcademicReviewRows.push({
                    id: rowId,
                    srno: srno
                });
                console.log(`Tracking deleted academic_review row with srno ${srno}`);
            }
            
            fetch('/delete-academic-review-row', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `srno=${srno}&form_id=${formId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    row.remove();
                    updateSerialNumbers('academicReviewTable');
                    calculateAcademicReview();
                } else {
                    alert('Error deleting row: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting row. Please try again.');
            });
        } 
        // For other table types with row ID
        else if (rowId) {
            // Store the row ID in our tracking array before deleting
            if (tableType === 'teaching') {
                deletedTeachingRows.push(rowId);
                console.log(`Tracking deleted teaching row with ID ${rowId}`);
            } else if (tableType === 'feedback') {
                deletedFeedbackRows.push(rowId);
                console.log(`Tracking deleted feedback row with ID ${rowId}`);
            }
            
            fetch('/delete_row', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    row_id: rowId,
                    table_type: tableType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    row.remove();
                    // Recalculate totals after deletion
                    if (tableType === 'teaching') {
                        calculateTotalPoints();
                        updateSerialNumbers('classTable');
                    } else if (tableType === 'feedback') {
                        calculateFeedbackTotal();
                        updateSerialNumbers('feedbackTable');
                    }
                } else {
                    alert('Error deleting row: ' + data.error);
                    // Remove from tracking if server deletion failed
                    if (tableType === 'teaching') {
                        deletedTeachingRows = deletedTeachingRows.filter(id => id !== rowId);
                    } else if (tableType === 'feedback') {
                        deletedFeedbackRows = deletedFeedbackRows.filter(id => id !== rowId);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting row. Please try again.');
                // Remove from tracking if server deletion failed
                if (tableType === 'teaching') {
                    deletedTeachingRows = deletedTeachingRows.filter(id => id !== rowId);
                } else if (tableType === 'feedback') {
                    deletedFeedbackRows = deletedFeedbackRows.filter(id => id !== rowId);
                }
            });
        } 
        // For rows without an ID (newly added)
        else {
            row.remove();
            // Recalculate totals after deletion
            if (tableType === 'teaching') {
                calculateTotalPoints();
                updateSerialNumbers('classTable');
            } else if (tableType === 'feedback') {
                calculateFeedbackTotal();
                updateSerialNumbers('feedbackTable');
            } else if (tableType === 'academic_review') {
                calculateAcademicReview();
                updateSerialNumbers('academicReviewTable');
            }
        }
    }
}



    
// Reset all form fields to initial state and remove all rows from both forms
function resetFields() {
    if (confirm('Are you sure you want to reset all fields?')) {
        const formId = document.getElementById('formId').value; // Get form_id from a hidden field or input

        // Send an API request to reset the form in the database
        fetch('/reset-form', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `formId=${encodeURIComponent(formId)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Clear and remove all rows for Teaching Process form
                const teachingTableBody = document.getElementById('classTable');
                teachingTableBody.innerHTML = ''; // Removes all rows from Teaching Process table

                // Clear and remove all rows for Feedback form
                const feedbackTableBody = document.getElementById('feedbackTable');
                feedbackTableBody.innerHTML = ''; // Removes all rows from Feedback table
                
                // Clear and remove all rows for Academic Review form
                const academicReviewTableBody = document.getElementById('academicReviewTable');
                academicReviewTableBody.innerHTML = ''; // Removes all rows from Academic Review table
                
                // Add a default row to Academic Review table
                addAcademicReviewRow();

                // Reset the total points display
                document.getElementById('totalPoints').textContent = '0';
                document.getElementById('teachingPoints').textContent = '0';
                document.getElementById('academicReviewPoints').textContent = '0';
                
                // Show success message
                alert('Form has been reset successfully!');
                
                // Optionally, add a new empty row to Teaching Process form
                addRow();
                
                // Add a new empty row to Feedback form
                addFeedbackRow();
            } else {
                alert('Error resetting form: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while resetting the form.');
        });
    }
}



// Function to calculate Points for Teaching Process
function calculatePoints(input) {
    const row = input.closest('tr');
    if (!row) return; // Safety check
    
    const scheduledInput = row.querySelector('.classes-scheduled');
    const heldInput = row.querySelector('.classes-held');
    const pointsInput = row.querySelector('.points');
    
    if (!scheduledInput || !heldInput || !pointsInput) return; // Safety check
    
    // Get values, ensure they're valid numbers
    let scheduled = parseFloat(scheduledInput.value) || 0;
    let held = parseFloat(heldInput.value) || 0;
    
    // Validate inputs
    if (scheduled < 0) {
        scheduled = 0;
        scheduledInput.value = '0';
    }
    
    if (held < 0) {
        held = 0;
        heldInput.value = '0';
    }
    
    // Ensure held doesn't exceed scheduled
    if (held > scheduled && scheduled > 0) {
        held = scheduled;
        heldInput.value = scheduled;
    }
    
    // Calculate points
    let points = 0;
    if (scheduled > 0) {
        points = (held / scheduled) * 5;
        // Limit to 2 decimal places
        points = parseFloat(points.toFixed(2));
    }
    
    pointsInput.value = points;
    
    // Update totals
    calculateTotalPoints();
}

// Function to calculate the average and total points for Teaching Process (max 5 marks)
function calculateTotalPoints() {
    const pointsCells = document.querySelectorAll('.points');
    let total = 0;
    let count = 0;

    pointsCells.forEach(cell => {
        const pointsValue = parseFloat(cell.value) || 0;
        if (pointsValue > 0) {
            total += pointsValue;
            count++;
        }
    });

    let average = 0;
    if (count > 0) {
        // Calculate average, round to nearest whole number, and ensure it doesn't exceed 5
        average = Math.min(Math.round(total / count), 5);
    }
    
    // Update the display with whole number
    document.getElementById('teachingPoints').textContent = average;
    updateTotalPoints();
}

// Function to calculate the average and total points for Feedback
function calculateFeedbackTotal() {
    const pointsCells = document.querySelectorAll('.points-obtained');
    let total = 0;
    let count = 0;

    pointsCells.forEach(cell => {
        const pointsValue = parseInt(cell.value) || 0;
        if (pointsValue > 0) {
            total += pointsValue;
            count++;
        }
    });

    // If there are valid rows, calculate the average (out of 5) and multiply by 5 for total out of 25
    if (count > 0) {
        const average = Math.round((total / count) * 5);
        document.getElementById('totalPointsObtained').innerText = average;
    } else {
        document.getElementById('totalPointsObtained').innerText = "0";
    }
}
 

    
function saveFormData() {
    try {
        let teachingData = [];
        let feedbackData = [];
        let formData = new FormData();

        // Collect Teaching Process Data
        document.querySelectorAll('#classTable tr').forEach((row, index) => {
            let rowId = row.getAttribute('data-id') || '';
            let srno = index + 1;
            let semester = row.querySelector('.semester')?.value || '';
            let course = row.querySelector('.course-dropdown')?.value || '';
            let scheduled = row.querySelector('.classes-scheduled')?.value || '';
            let held = row.querySelector('.classes-held')?.value || '';
            let points = row.querySelector('.points')?.value || '0';

            teachingData.push({
                id: rowId,
                srno: srno,
                semester: semester,
                course: course,
                scheduled: scheduled,
                held: held,
                points: points
            });
        });

        // Collect Feedback Data
        document.querySelectorAll('#feedbackTable tr').forEach((row, index) => {
            let rowId = row.getAttribute('data-id') || '';
            let srno = index + 1;
            let semester = row.querySelector('.semester')?.value || '';
            let course = row.querySelector('.course-dropdown')?.value || '';
            let totalPoints = row.querySelector('.total-points')?.value || '';
            let pointsObtained = row.querySelector('.points-obtained')?.value || '';
            let fileInput = row.querySelector('input[type="file"]');

            feedbackData.push({
                id: rowId,
                srno: srno,
                semester: semester,
                course: course,
                totalPoints: totalPoints,
                pointsObtained: pointsObtained
            });

            if (fileInput && fileInput.files.length > 0) {
                formData.append(`files[${index}]`, fileInput.files[0]);
            }
        });

        // Collect Academic Review Data
        let academicReviewData = [];
        document.querySelectorAll('#academicReviewTable tr').forEach((row) => {
            const srno = row.querySelector('.sr-no')?.textContent.trim();
            const reviewInputs = row.querySelectorAll('input.academic-review');
            const review1 = reviewInputs[0]?.value || '0';
            const review2 = reviewInputs[1]?.value || '0';
            const avgScore = row.querySelector('.academic-review-avg')?.value || '0';
            
            if (srno) {
                academicReviewData.push({
                    srno: parseInt(srno),
                    review1: review1,
                    review2: review2,
                    avgScore: avgScore
                });
            }
        });

        // Add form data
        formData.append('teachingData', JSON.stringify(teachingData));
        feedbackData.forEach((feedback, index) => {
            formData.append('feedback[]', JSON.stringify(feedback));
        });
        academicReviewData.forEach((review, index) => {
            formData.append('academicReview[]', JSON.stringify(review));
        });
        
        // Add deleted row IDs to handle proper removal from database
        if (deletedTeachingRows.length > 0) {
            formData.append('deletedTeachingRows', JSON.stringify(deletedTeachingRows));
            console.log('Sending deleted teaching rows:', deletedTeachingRows);
        }
        
        if (deletedFeedbackRows.length > 0) {
            formData.append('deletedFeedbackRows', JSON.stringify(deletedFeedbackRows));
            console.log('Sending deleted feedback rows:', deletedFeedbackRows);
        }
        
        if (deletedAcademicReviewRows.length > 0) {
            formData.append('deletedAcademicReviewRows', JSON.stringify(deletedAcademicReviewRows));
            console.log('Sending deleted academic review rows:', deletedAcademicReviewRows);
        }

        // --- Handle Save Success Popup ---
        // Attach a handler to show alert after fetch if not already present
        if (window.saveAcademicFormHandlerAttached !== true) {
            const saveBtn = document.getElementById('saveButton');
            if (saveBtn) {
                saveBtn.addEventListener('click', function(event) {
                    setTimeout(() => {
                        // Listen for a response from the backend
                        fetch('/save-form-data', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Form data saved successfully!');
                            }
                        });
                    }, 100);
                });
                window.saveAcademicFormHandlerAttached = true;
            }
        }
        formData.append('formId', document.getElementById('formId').value);

        // Show loading message
        const flashMessage = document.getElementById('flashMessage');
        flashMessage.textContent = 'Saving data...';
        flashMessage.style.display = 'block';
        flashMessage.style.backgroundColor = '#d4edda';
        flashMessage.style.color = '#155724';

        // Send data to server
        $.ajax({
            url: '/save-form-data',
            method: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function(response) {
                if (response.status === 'success') {
                        console.log('Test save success:', response);
                        alert('Form data saved successfully!');
                    // Update row IDs with the ones returned from the server
                    response.teaching_ids.forEach((id, index) => {
                        const row = document.querySelectorAll('#classTable tr')[index];
                        if (row) row.setAttribute('data-id', id);
                    });
                    
                    response.feedback_ids.forEach((id, index) => {
                        const row = document.querySelectorAll('#feedbackTable tr')[index];
                        if (row) row.setAttribute('data-id', id);
                    });
                    
                    response.academic_review_ids.forEach((id, index) => {
                        const row = document.querySelectorAll('#academicReviewTable tr')[index];
                        if (row) row.setAttribute('data-id', id);
                    });

                    // Update totals display
                    if (response.totals) {
                        document.getElementById('totalPoints').innerText = Math.round(response.totals.teaching);
                        document.getElementById('totalPointsObtained').innerText = Math.round(response.totals.feedback);
                        const academicReviewAvg = document.querySelector('.academic-review-avg');
                        if (academicReviewAvg) {
                            academicReviewAvg.value = Math.round(response.totals.academic_review);
                        }
                    }

                    // Show success message
                    flashMessage.textContent = 'Form data saved successfully!';
                    flashMessage.style.backgroundColor = '#d4edda';
                    flashMessage.style.color = '#155724';
                    
                    setTimeout(() => {
                        flashMessage.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(response.message || 'Failed to save data');
                }
            },
            error: function(xhr, status, error) {
                flashMessage.textContent = 'Error saving form data: ' + (xhr.responseText || error);
                flashMessage.style.backgroundColor = '#f8d7da';
                flashMessage.style.color = '#721c24';
                
                setTimeout(() => {
                    flashMessage.style.display = 'none';
                }, 5000);
                
                console.error('Error saving form data:', xhr.responseText || error);
            }
        });
    } catch (error) {
        console.error('Error in saveFormData:', error);
        alert('Error preparing form data: ' + error.message);
    }
}



// Upload function with validation and hidden filename storage
function uploadDocument(input) {
    const file = input.files[0];
    const uploadStatus = input.nextElementSibling; // The <div class="upload-status">

    // --------------------------------------------------
    // Basic checks
    // --------------------------------------------------
    if (!file) {
        alert("Please select a file to upload.");
        return;
    }

    // --------------------------------------------------
    // Client-side validation â€“ size & type
    // --------------------------------------------------
    const maxSizeMB = 1; // 1 MB limit
    if (file.size > maxSizeMB * 1024 * 1024) {
        uploadStatus.textContent = `File size must be less than ${maxSizeMB} MB`;
        uploadStatus.style.color = 'red';
        input.value = '';
        return;
    }

    const allowedTypes = ['.pdf', '.doc', '.docx'];
    const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
    if (!allowedTypes.includes(fileExt)) {
        uploadStatus.textContent = 'Only PDF or Word documents (.pdf, .doc, .docx) are allowed';
        uploadStatus.style.color = 'red';
        input.value = '';
        return;
    }

    // --------------------------------------------------
    // Perform upload
    // --------------------------------------------------
    const formData = new FormData();
    formData.append('file', file);

    fetch('/upload', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            uploadStatus.textContent = `Error: ${data.error}`;
            uploadStatus.style.color = 'red';
            input.value = '';
        } else {
            uploadStatus.textContent = `Uploaded: ${data.filename}`;
            uploadStatus.style.color = 'green';

            // --------------------------------------------------
            // Append / update hidden input with uploaded filename
            // --------------------------------------------------
            let hiddenInput = input.parentNode.querySelector('input[type="hidden"][name="uploaded_file"]');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'uploaded_file';
                input.parentNode.appendChild(hiddenInput);
            }
            hiddenInput.value = data.filename;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        uploadStatus.textContent = 'Upload failed!';
        uploadStatus.style.color = 'red';
        input.value = '';
    });
}



function goToNext() {
    let totalPoints = parseInt(document.getElementById('totalPoints').innerText);
    let totalPointsObtained = parseInt(document.getElementById('totalPointsObtained').innerText);
    let academicReviewAvg = parseInt(document.querySelector('.academic-review-avg').value) || 0;
    
    let overallTotal = totalPoints + totalPointsObtained + academicReviewAvg;
    
    let formId = document.getElementById('formId').value;

    if (!formId || isNaN(overallTotal)) {
        console.error("Invalid form ID or points.");
        alert("Error: Please ensure all form data is filled correctly.");
        return;
    }

    $.ajax({
        url: '/save-total-points',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            form_id: formId,
            total: overallTotal,
            teaching: totalPoints,
            feedback: totalPointsObtained,
            academic_review: academicReviewAvg
        }),
        success: function(response) {
            window.location.href = "/form2/" + formId;
        },
        error: function(error) {
            console.error("Error saving total points:", error);
            alert("There was an error saving the total points. Please try again.");
        }
    });
}

// Function to update the total points display
function updateTotalPoints() {
    const teachingPoints = parseInt(document.getElementById('teachingPoints').textContent) || 0;
    const academicReviewPoints = parseInt(document.getElementById('academicReviewPoints').textContent) || 0;
    
    // Calculate total (teaching is out of 5, academic review out of 20)
    const totalPoints = teachingPoints + academicReviewPoints;
    
    // Update the display with whole number
    document.getElementById('totalPoints').textContent = totalPoints;
}

// Calculate totals when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add teaching points display if it doesn't exist
    if (!document.getElementById('teachingPoints')) {
        const teachingBox = document.querySelector('.total-box');
        teachingBox.insertAdjacentHTML('beforeend', ' | Teaching: <span id="teachingPoints">0</span>/5');
    }
    
    // Add academic review points display if it doesn't exist
    if (!document.getElementById('academicReviewPoints')) {
        const reviewBox = document.querySelector('.total-box');
        reviewBox.insertAdjacentHTML('beforeend', ' | Academic Review: <span id="academicReviewPoints">0</span>/20');
    }
    
    // Initialize all points calculations for existing teaching rows
    document.querySelectorAll('#classTable tr').forEach(row => {
        const scheduledInput = row.querySelector('.classes-scheduled');
        if (scheduledInput) {
            // Trigger calculation for each existing row
            calculatePoints(scheduledInput);
        }
    });
    
    calculateTotalPoints();
    calculateFeedbackTotal();
    calculateAcademicReview();
});

// Function for Academic Review calculations (max 20 marks)
function calculateAcademicReview() {
    const table = document.getElementById('academicReviewTable');
    const rows = table.getElementsByTagName('tr');
    let total = 0;
    let count = 0;
    let hasError = false;
    const errorMessage = document.getElementById('academicReviewError');
    
    // Reset error message
    if (errorMessage) {
        errorMessage.textContent = '';
        errorMessage.style.display = 'none';
    }

    // Loop through each row in the table
    for (let row of rows) {
        const reviews = row.querySelectorAll('.academic-review');
        let rowTotal = 0;
        let rowCount = 0;

        // Calculate average for this row
        reviews.forEach(input => {
            const value = parseFloat(input.value) || 0;
            if (value > 0) {
                // Check if value exceeds 20
                if (value > 20) {
                    hasError = true;
                    input.style.border = '1px solid red';
                    input.value = ''; // Clear the invalid input
                    // Show error message
                    if (errorMessage) {
                        errorMessage.textContent = 'Error: Points cannot exceed 20. Please enter a value between 0 and 20.';
                        errorMessage.style.display = 'block';
                        errorMessage.style.color = 'red';
                        errorMessage.style.marginTop = '5px';
                    }
                } else {
                    input.style.border = '';
                }
                // Ensure individual review doesn't exceed 20
                rowTotal += Math.min(Math.round(value), 20);
                rowCount++;
            } else {
                input.style.border = '';
            }
        });

        // If row has valid values, calculate its average
        if (rowCount > 0 && !hasError) {
            const rowAverage = Math.round(rowTotal / rowCount);
            const avgInput = row.querySelector('.academic-review-avg');
            // Store the rounded average in the input
            avgInput.value = rowAverage;
            total += rowAverage;
            count++;
        }
    }
    
    // Calculate final average across all rows (not to exceed 20)
    let finalAverage = 0;
    if (count > 0 && !hasError) {
        finalAverage = Math.min(Math.round(total / count), 20);
    }
    
    // Update the display with whole number
    document.getElementById('academicReviewPoints').textContent = finalAverage;
    updateTotalPoints();
}

// Add this function in the script section
function addAcademicReviewRow() {
    const tbody = document.getElementById('academicReviewTable');
    const rowCount = tbody.getElementsByTagName('tr').length + 1;
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-srno', rowCount);
    newRow.innerHTML = `
        <td class="sr-no">${rowCount}</td>
        <td><input type="number" class="form-control academic-review" min="0" max="20" oninput="calculateAcademicReview()" required></td>
        <td><input type="number" class="form-control academic-review" min="0" max="20" oninput="calculateAcademicReview()" required></td>
        <td><input type="number" class="form-control academic-review-avg" readonly></td>
        <td>
            <button class="btn btn-danger" onclick="deleteRow(this, 'academic_review')">-</button>
        </td>
    `;
    tbody.appendChild(newRow);
    calculateAcademicReview();
}
</script>

<br>

<div class="footer">
    <p>Developed by Mayank Salvi, Aniruddha Sangle, and Gandhar Rane under the guidance of Prof. Vishal S. Badgujar. 
    Want to know more about the team behind this project? <a href="/about_us">Find out here</a>.</p>
</div>
    
</body>
</html>